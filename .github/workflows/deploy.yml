name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # Ã‰tape 1 : Cloner le dÃ©pÃ´t
    - name: Checkout code
      uses: actions/checkout@v4

    # Ã‰tape 2 : Configurer la clÃ© SSH pour se connecter au VPS
    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

    # Ã‰tape 3 : DÃ©ployer sur le VPS Debian 11
    - name: Deploy to VPS
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
          set -e  # ArrÃªter sur premiÃ¨re erreur

          # Aller dans le rÃ©pertoire de ton projet sur le VPS
          cd /var/www/html/gperegistration

          # S'assurer que Git est configurÃ© pour accepter les pulls
          git config --global --add safe.directory /var/www/html/gperegistration

          echo "ðŸ“‚ Statut Git avant pull :"
          git status

          # GÃ©rer les changements locaux : stash pour Ã©viter conflits
          if ! git diff --quiet; then
            echo "ðŸ’¾ Changements locaux dÃ©tectÃ©s, on stash..."
            git stash push -m "Auto-stash avant deploy $(date)"
          fi

          # Mettre Ã  jour le code
          echo "ðŸ”„ Pull en cours..."
          git pull origin main

          # VÃ©rifier post-pull
          echo "ðŸ“‚ Statut Git aprÃ¨s pull :"
          git status

          # Si conflit persiste (rare aprÃ¨s stash), reset hard (ATTENTION : perd mods locales !)
          if git status | grep -q "You are in the middle of a conflicted merge"; then
            echo "âš ï¸ Conflit dÃ©tectÃ©, reset hard vers origin/main..."
            git reset --hard origin/main
            git clean -fd  # Nettoie fichiers non trackÃ©s
          fi

          # Drop le stash si existant (pour garder clean ; commente si tu veux pop aprÃ¨s test)
          if git stash list | grep -q "Auto-stash"; then
            echo "ðŸ—‘ï¸ Drop stash auto..."
            git stash drop
          fi

          # Installer les dÃ©pendances
          echo "ðŸ“¦ Installation npm..."
          npm ci --only=production  # Plus rapide que install, ignore dev deps

          # RedÃ©marrer l'application avec PM2
          echo "ðŸ”„ Restart PM2..."
          if pm2 list | grep -q "gperegistration"; then
            pm2 restart gperegistration
          else
            echo "ðŸš€ Start PM2 avec ecosystem.config.js..."
            if [ -f ecosystem.config.js ]; then
              pm2 start ecosystem.config.js --name gperegistration
            else
              echo "âŒ ecosystem.config.js absent, start manuel (adapte si besoin)"
              # Ex. : pm2 start server.js --name gperegistration
              exit 1  # Stop si config manquante
            fi
          fi

          pm2 save  # Sauvegarde l'Ã©tat PM2
          echo "âœ… Deploy terminÃ© !"
        EOF